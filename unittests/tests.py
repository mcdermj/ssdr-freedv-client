import unittest
from unittest.mock import patch
import ssdrframe
import ssdrapiclient
import twisted.protocols.basic
from twisted.trial.unittest import TestCase
from ssdrapiclient import CommandFailure


def line_printer(cls, message: str) -> None:
    print("Sending: {}".format(message))


@patch('ssdrframe.SsdrFdvClientFrame', autospec=True)
@patch('twisted.protocols.basic.LineOnlyReceiver.sendLine', autospec=True, side_effect=line_printer)
class TestAPIClient(TestCase):
    def test_command_success(self, send_line, client_frame):
        api_client = ssdrapiclient.SsdrApiProtocol(client_frame)
        message = api_client.send_command('sub slice all')
        api_client.lineReceived('R0|0|command successful'.encode('utf-8'))
        self.assertEqual('command successful', self.successResultOf(message))

    def test_command_failure(self, send_line, client_frame):
        api_client = ssdrapiclient.SsdrApiProtocol(client_frame)
        command = api_client.send_command('sub slice all')
        api_client.lineReceived('R0|80001000|you screwed up'.encode('utf-8'))
        fail = self.failureResultOf(command, CommandFailure)
        self.assertEqual('you screwed up', fail.value.message)
        self.assertEqual(80001000, fail.value.errno)

    def test_load_meter(self, send_line, client_frame):
        api_client = ssdrapiclient.SsdrApiProtocol(client_frame)
        meters = api_client.load_meters()
        api_client.lineReceived('R0|0|meter 1.src=COD-#1.num=1#1.nam=MICPEAK#1.low=-150.0#1.hi=20.0#1.desc=Signal strength of MIC output in CODEC#1.unit=dBFS#1.fps=40#2.src=COD-#2.num=2#2.nam=MIC#2.low=-150.0#2.hi=20.0#2.desc=Average Signal strength of MIC ouput in CODEC#2.unit=dBFS#2.fps=20#3.src=TX-#3.num=8#3.nam=CODEC#3.low=-150.0#3.hi=20.0#3.desc=Signal strength of CODEC output#3.unit=dBFS#3.fps=10#4.src=TX-#4.num=8#4.nam=SC_MIC#4.low=-150.0#4.hi=20.0#4.desc=Signal strength of MIC output#4.unit=dBFS#4.fps=10#5.src=TX-#5.num=8#5.nam=COMPPEAK#5.low=-150.0#5.hi=20.0#5.desc=Signal strength of signals after the CLIPPER (Compression)#5.unit=dBFS#5.fps=20#6.src=TX-#6.num=8#6.nam=SC_FILT_1#6.low=-150.0#6.hi=20.0#6.desc=Signal strength after Filter 1#6.unit=dBFS#6.fps=10#7.src=TX-#7.num=8#7.nam=ALC#7.low=-150.0#7.hi=20.0#7.desc=Signal strength of signals after SW ALC (SSB Peak)#7.unit=dBFS#7.fps=10#8.src=TX-#8.num=8#8.nam=PRE_WAVE_AGC#8.low=-150.0#8.hi=20.0#8.desc=Signal strength before Waveform AGC#8.unit=dBFS#8.fps=10#9.src=TX-#9.num=8#9.nam=PRE_WAVE#9.low=-150.0#9.hi=20.0#9.desc=Signal strength before Waveform Shim#9.unit=dBFS#9.fps=10#10.src=TX-#10.num=8#10.nam=SC_FILT_2#10.low=-150.0#10.hi=20.0#10.desc=Signal strength after Filter 2#10.unit=dBFS#10.fps=10#11.src=TX-#11.num=8#11.nam=B4RAMP#11.low=-150.0#11.hi=20.0#11.desc=Signal strength of signals before the ramp#11.unit=dBFS#11.fps=10#12.src=TX-#12.num=8#12.nam=AFRAMP#12.low=-150.0#12.hi=20.0#12.desc=Signal strength of signals after the ramp#12.unit=dBFS#12.fps=10#13.src=TX-#13.num=8#13.nam=GAIN#13.low=-150.0#13.hi=0.0#13.desc=Signal strength after Gain#13.unit=dBFS#13.fps=10#14.src=TX-#14.num=5#14.nam=HWALC#14.low=-150.0#14.hi=20.0#14.desc=Voltage present at the Hardware ALC RCA Plug#14.unit=dBFS#14.fps=20#15.src=RAD#15.num=334#15.nam=+13.8A#15.low=10.5#15.hi=15.0#15.desc=Main radio input voltage at PA#15.unit=Volts#15.fps=0#16.src=RAD#16.num=0#16.nam=+13.8B#16.low=10.5#16.hi=15.0#16.desc=Main radio input voltage at CPU (continuous)#16.unit=Volts#16.fps=0#17.src=RAD#17.num=3#17.nam=MAINFAN#17.low=0.0#17.hi=8192.0#17.desc=Main radio fan RPM#17.unit=RPM#17.fps=0#18.src=TX-#18.num=1#18.nam=FWDPWR#18.low=0.0#18.hi=53.0#18.desc=RF Power Forward#18.unit=dBm#18.fps=20#19.src=TX-#19.num=2#19.nam=REFPWR#19.low=0.0#19.hi=53.0#19.desc=RF Power Reflected#19.unit=dBm#19.fps=20#20.src=TX-#20.num=3#20.nam=SWR#20.low=1.0#20.hi=999.0#20.desc=RF SWR#20.unit=SWR#20.fps=20#21.src=TX-#21.num=4#21.nam=PATEMP#21.low=0.0#21.hi=100.0#21.desc=PA Temperature#21.unit=degC#21.fps=0#22.src=SLC#22.num=0#22.nam=24kHz#22.low=-150.0#22.hi=10.0#22.desc=24kHz broadband slice receiver signal level#22.unit=dBFS#22.fps=10#23.src=SLC#23.num=0#23.nam=LEVEL#23.low=-150.0#23.hi=20.0#23.desc=Signal strength of signals in the filter passband#23.unit=dBm#23.fps=10#24.src=SLC#24.num=0#24.nam=AGC+#24.low=-150.0#24.hi=0.0#24.desc=Signal strength after AGC#24.unit=dBFS#24.fps=10#25.src=SLC#25.num=0#25.nam=AM#25.low=-150.0#25.hi=20.0#25.desc=Signal strength after AM#25.unit=dBm#25.fps=10#26.src=SLC#26.num=1#26.nam=24kHz#26.low=-150.0#26.hi=10.0#26.desc=24kHz broadband slice receiver signal level#26.unit=dBFS#26.fps=10#27.src=SLC#27.num=1#27.nam=LEVEL#27.low=-150.0#27.hi=20.0#27.desc=Signal strength of signals in the filter passband#27.unit=dBm#27.fps=10#28.src=SLC#28.num=1#28.nam=AGC+#28.low=-150.0#28.hi=0.0#28.desc=Signal strength after AGC#28.unit=dBFS#28.fps=10#29.src=SLC#29.num=1#29.nam=AM#29.low=-150.0#29.hi=20.0#29.desc=Signal strength after AM#29.unit=dBm#29.fps=10#30.src=WVF#30.num=0x58E3A588#30.nam=fdv-snr#30.low=-100.0#30.hi=100.0#30.desc=External Meter#30.unit=dB#30.fps=0#31.src=WVF#31.num=0x58E3A588#31.nam=fdv-foff#31.low=0.0#31.hi=1000000.0#31.desc=External Meter#31.unit=dB#31.fps=0#32.src=WVF#32.num=0x58E3A588#32.nam=fdv-clock-offset#32.low=0.0#32.hi=1000000.0#32.desc=External Meter#32.unit=dB#32.fps=0#33.src=WVF#33.num=0x58E3A588#33.nam=fdv-sync-quality#33.low=0.0#33.hi=1.0#33.desc=External Meter#33.unit=dB#33.fps=0#34.src=WVF#34.num=0x58E3A588#34.nam=fdv-total-bits-lsb#34.low=0.0#34.hi=1000000.0#34.desc=External Meter#34.unit=RPM#34.fps=0#35.src=WVF#35.num=0x58E3A588#35.nam=fdv-total-bits-msb#35.low=0.0#35.hi=1000000.0#35.desc=External Meter#35.unit=RPM#35.fps=0#36.src=WVF#36.num=0x58E3A588#36.nam=fdv-error-bits#36.low=0.0#36.hi=1000000.0#36.desc=External Meter#36.unit=RPM#36.fps=0#37.src=WVF#37.num=0x58E3A588#37.nam=fdv-ber#37.low=0.0#37.hi=10000000.0#37.desc=External Meter#37.unit=RPM#37.fps=0#'.encode('utf-8'))
        self.assertEqual(None, self.successResultOf(meters))
        self.assertIn('fdv-snr', api_client.meters)
        self.assertEqual(30, api_client.meters['fdv-snr'])

    def test_sub_meter(self, send_line, client_frame):
        api_client = ssdrapiclient.SsdrApiProtocol(client_frame)
        meters = api_client.subscribe_meters(['fdv-snr', 'fdv-foff'])
        api_client.lineReceived('R0|0|meter 1.src=COD-#1.num=1#1.nam=MICPEAK#1.low=-150.0#1.hi=20.0#1.desc=Signal strength of MIC output in CODEC#1.unit=dBFS#1.fps=40#2.src=COD-#2.num=2#2.nam=MIC#2.low=-150.0#2.hi=20.0#2.desc=Average Signal strength of MIC ouput in CODEC#2.unit=dBFS#2.fps=20#3.src=TX-#3.num=8#3.nam=CODEC#3.low=-150.0#3.hi=20.0#3.desc=Signal strength of CODEC output#3.unit=dBFS#3.fps=10#4.src=TX-#4.num=8#4.nam=SC_MIC#4.low=-150.0#4.hi=20.0#4.desc=Signal strength of MIC output#4.unit=dBFS#4.fps=10#5.src=TX-#5.num=8#5.nam=COMPPEAK#5.low=-150.0#5.hi=20.0#5.desc=Signal strength of signals after the CLIPPER (Compression)#5.unit=dBFS#5.fps=20#6.src=TX-#6.num=8#6.nam=SC_FILT_1#6.low=-150.0#6.hi=20.0#6.desc=Signal strength after Filter 1#6.unit=dBFS#6.fps=10#7.src=TX-#7.num=8#7.nam=ALC#7.low=-150.0#7.hi=20.0#7.desc=Signal strength of signals after SW ALC (SSB Peak)#7.unit=dBFS#7.fps=10#8.src=TX-#8.num=8#8.nam=PRE_WAVE_AGC#8.low=-150.0#8.hi=20.0#8.desc=Signal strength before Waveform AGC#8.unit=dBFS#8.fps=10#9.src=TX-#9.num=8#9.nam=PRE_WAVE#9.low=-150.0#9.hi=20.0#9.desc=Signal strength before Waveform Shim#9.unit=dBFS#9.fps=10#10.src=TX-#10.num=8#10.nam=SC_FILT_2#10.low=-150.0#10.hi=20.0#10.desc=Signal strength after Filter 2#10.unit=dBFS#10.fps=10#11.src=TX-#11.num=8#11.nam=B4RAMP#11.low=-150.0#11.hi=20.0#11.desc=Signal strength of signals before the ramp#11.unit=dBFS#11.fps=10#12.src=TX-#12.num=8#12.nam=AFRAMP#12.low=-150.0#12.hi=20.0#12.desc=Signal strength of signals after the ramp#12.unit=dBFS#12.fps=10#13.src=TX-#13.num=8#13.nam=GAIN#13.low=-150.0#13.hi=0.0#13.desc=Signal strength after Gain#13.unit=dBFS#13.fps=10#14.src=TX-#14.num=5#14.nam=HWALC#14.low=-150.0#14.hi=20.0#14.desc=Voltage present at the Hardware ALC RCA Plug#14.unit=dBFS#14.fps=20#15.src=RAD#15.num=334#15.nam=+13.8A#15.low=10.5#15.hi=15.0#15.desc=Main radio input voltage at PA#15.unit=Volts#15.fps=0#16.src=RAD#16.num=0#16.nam=+13.8B#16.low=10.5#16.hi=15.0#16.desc=Main radio input voltage at CPU (continuous)#16.unit=Volts#16.fps=0#17.src=RAD#17.num=3#17.nam=MAINFAN#17.low=0.0#17.hi=8192.0#17.desc=Main radio fan RPM#17.unit=RPM#17.fps=0#18.src=TX-#18.num=1#18.nam=FWDPWR#18.low=0.0#18.hi=53.0#18.desc=RF Power Forward#18.unit=dBm#18.fps=20#19.src=TX-#19.num=2#19.nam=REFPWR#19.low=0.0#19.hi=53.0#19.desc=RF Power Reflected#19.unit=dBm#19.fps=20#20.src=TX-#20.num=3#20.nam=SWR#20.low=1.0#20.hi=999.0#20.desc=RF SWR#20.unit=SWR#20.fps=20#21.src=TX-#21.num=4#21.nam=PATEMP#21.low=0.0#21.hi=100.0#21.desc=PA Temperature#21.unit=degC#21.fps=0#22.src=SLC#22.num=0#22.nam=24kHz#22.low=-150.0#22.hi=10.0#22.desc=24kHz broadband slice receiver signal level#22.unit=dBFS#22.fps=10#23.src=SLC#23.num=0#23.nam=LEVEL#23.low=-150.0#23.hi=20.0#23.desc=Signal strength of signals in the filter passband#23.unit=dBm#23.fps=10#24.src=SLC#24.num=0#24.nam=AGC+#24.low=-150.0#24.hi=0.0#24.desc=Signal strength after AGC#24.unit=dBFS#24.fps=10#25.src=SLC#25.num=0#25.nam=AM#25.low=-150.0#25.hi=20.0#25.desc=Signal strength after AM#25.unit=dBm#25.fps=10#26.src=SLC#26.num=1#26.nam=24kHz#26.low=-150.0#26.hi=10.0#26.desc=24kHz broadband slice receiver signal level#26.unit=dBFS#26.fps=10#27.src=SLC#27.num=1#27.nam=LEVEL#27.low=-150.0#27.hi=20.0#27.desc=Signal strength of signals in the filter passband#27.unit=dBm#27.fps=10#28.src=SLC#28.num=1#28.nam=AGC+#28.low=-150.0#28.hi=0.0#28.desc=Signal strength after AGC#28.unit=dBFS#28.fps=10#29.src=SLC#29.num=1#29.nam=AM#29.low=-150.0#29.hi=20.0#29.desc=Signal strength after AM#29.unit=dBm#29.fps=10#30.src=WVF#30.num=0x58E3A588#30.nam=fdv-snr#30.low=-100.0#30.hi=100.0#30.desc=External Meter#30.unit=dB#30.fps=0#31.src=WVF#31.num=0x58E3A588#31.nam=fdv-foff#31.low=0.0#31.hi=1000000.0#31.desc=External Meter#31.unit=dB#31.fps=0#32.src=WVF#32.num=0x58E3A588#32.nam=fdv-clock-offset#32.low=0.0#32.hi=1000000.0#32.desc=External Meter#32.unit=dB#32.fps=0#33.src=WVF#33.num=0x58E3A588#33.nam=fdv-sync-quality#33.low=0.0#33.hi=1.0#33.desc=External Meter#33.unit=dB#33.fps=0#34.src=WVF#34.num=0x58E3A588#34.nam=fdv-total-bits-lsb#34.low=0.0#34.hi=1000000.0#34.desc=External Meter#34.unit=RPM#34.fps=0#35.src=WVF#35.num=0x58E3A588#35.nam=fdv-total-bits-msb#35.low=0.0#35.hi=1000000.0#35.desc=External Meter#35.unit=RPM#35.fps=0#36.src=WVF#36.num=0x58E3A588#36.nam=fdv-error-bits#36.low=0.0#36.hi=1000000.0#36.desc=External Meter#36.unit=RPM#36.fps=0#37.src=WVF#37.num=0x58E3A588#37.nam=fdv-ber#37.low=0.0#37.hi=10000000.0#37.desc=External Meter#37.unit=RPM#37.fps=0#'.encode('utf-8'))

        api_client.lineReceived('R1|0|'.encode('utf-8'))
        api_client.lineReceived('R2|0|'.encode('utf-8'))

        self.assertEqual(None, self.successResultOf(meters))

    def test_connection_made(self, send_line, client_frame):
        api_client = ssdrapiclient.SsdrApiProtocol(client_frame)
        conn = api_client.connectionMade()
        api_client.lineReceived('R0|0|'.encode('utf-8'))
        api_client.lineReceived('R1|0|'.encode('utf-8'))
        api_client.lineReceived('R2|0|meter 1.src=COD-#1.num=1#1.nam=MICPEAK#1.low=-150.0#1.hi=20.0#1.desc=Signal strength of MIC output in CODEC#1.unit=dBFS#1.fps=40#2.src=COD-#2.num=2#2.nam=MIC#2.low=-150.0#2.hi=20.0#2.desc=Average Signal strength of MIC ouput in CODEC#2.unit=dBFS#2.fps=20#3.src=TX-#3.num=8#3.nam=CODEC#3.low=-150.0#3.hi=20.0#3.desc=Signal strength of CODEC output#3.unit=dBFS#3.fps=10#4.src=TX-#4.num=8#4.nam=SC_MIC#4.low=-150.0#4.hi=20.0#4.desc=Signal strength of MIC output#4.unit=dBFS#4.fps=10#5.src=TX-#5.num=8#5.nam=COMPPEAK#5.low=-150.0#5.hi=20.0#5.desc=Signal strength of signals after the CLIPPER (Compression)#5.unit=dBFS#5.fps=20#6.src=TX-#6.num=8#6.nam=SC_FILT_1#6.low=-150.0#6.hi=20.0#6.desc=Signal strength after Filter 1#6.unit=dBFS#6.fps=10#7.src=TX-#7.num=8#7.nam=ALC#7.low=-150.0#7.hi=20.0#7.desc=Signal strength of signals after SW ALC (SSB Peak)#7.unit=dBFS#7.fps=10#8.src=TX-#8.num=8#8.nam=PRE_WAVE_AGC#8.low=-150.0#8.hi=20.0#8.desc=Signal strength before Waveform AGC#8.unit=dBFS#8.fps=10#9.src=TX-#9.num=8#9.nam=PRE_WAVE#9.low=-150.0#9.hi=20.0#9.desc=Signal strength before Waveform Shim#9.unit=dBFS#9.fps=10#10.src=TX-#10.num=8#10.nam=SC_FILT_2#10.low=-150.0#10.hi=20.0#10.desc=Signal strength after Filter 2#10.unit=dBFS#10.fps=10#11.src=TX-#11.num=8#11.nam=B4RAMP#11.low=-150.0#11.hi=20.0#11.desc=Signal strength of signals before the ramp#11.unit=dBFS#11.fps=10#12.src=TX-#12.num=8#12.nam=AFRAMP#12.low=-150.0#12.hi=20.0#12.desc=Signal strength of signals after the ramp#12.unit=dBFS#12.fps=10#13.src=TX-#13.num=8#13.nam=GAIN#13.low=-150.0#13.hi=0.0#13.desc=Signal strength after Gain#13.unit=dBFS#13.fps=10#14.src=TX-#14.num=5#14.nam=HWALC#14.low=-150.0#14.hi=20.0#14.desc=Voltage present at the Hardware ALC RCA Plug#14.unit=dBFS#14.fps=20#15.src=RAD#15.num=334#15.nam=+13.8A#15.low=10.5#15.hi=15.0#15.desc=Main radio input voltage at PA#15.unit=Volts#15.fps=0#16.src=RAD#16.num=0#16.nam=+13.8B#16.low=10.5#16.hi=15.0#16.desc=Main radio input voltage at CPU (continuous)#16.unit=Volts#16.fps=0#17.src=RAD#17.num=3#17.nam=MAINFAN#17.low=0.0#17.hi=8192.0#17.desc=Main radio fan RPM#17.unit=RPM#17.fps=0#18.src=TX-#18.num=1#18.nam=FWDPWR#18.low=0.0#18.hi=53.0#18.desc=RF Power Forward#18.unit=dBm#18.fps=20#19.src=TX-#19.num=2#19.nam=REFPWR#19.low=0.0#19.hi=53.0#19.desc=RF Power Reflected#19.unit=dBm#19.fps=20#20.src=TX-#20.num=3#20.nam=SWR#20.low=1.0#20.hi=999.0#20.desc=RF SWR#20.unit=SWR#20.fps=20#21.src=TX-#21.num=4#21.nam=PATEMP#21.low=0.0#21.hi=100.0#21.desc=PA Temperature#21.unit=degC#21.fps=0#22.src=SLC#22.num=0#22.nam=24kHz#22.low=-150.0#22.hi=10.0#22.desc=24kHz broadband slice receiver signal level#22.unit=dBFS#22.fps=10#23.src=SLC#23.num=0#23.nam=LEVEL#23.low=-150.0#23.hi=20.0#23.desc=Signal strength of signals in the filter passband#23.unit=dBm#23.fps=10#24.src=SLC#24.num=0#24.nam=AGC+#24.low=-150.0#24.hi=0.0#24.desc=Signal strength after AGC#24.unit=dBFS#24.fps=10#25.src=SLC#25.num=0#25.nam=AM#25.low=-150.0#25.hi=20.0#25.desc=Signal strength after AM#25.unit=dBm#25.fps=10#26.src=SLC#26.num=1#26.nam=24kHz#26.low=-150.0#26.hi=10.0#26.desc=24kHz broadband slice receiver signal level#26.unit=dBFS#26.fps=10#27.src=SLC#27.num=1#27.nam=LEVEL#27.low=-150.0#27.hi=20.0#27.desc=Signal strength of signals in the filter passband#27.unit=dBm#27.fps=10#28.src=SLC#28.num=1#28.nam=AGC+#28.low=-150.0#28.hi=0.0#28.desc=Signal strength after AGC#28.unit=dBFS#28.fps=10#29.src=SLC#29.num=1#29.nam=AM#29.low=-150.0#29.hi=20.0#29.desc=Signal strength after AM#29.unit=dBm#29.fps=10#30.src=WVF#30.num=0x58E3A588#30.nam=fdv-snr#30.low=-100.0#30.hi=100.0#30.desc=External Meter#30.unit=dB#30.fps=0#31.src=WVF#31.num=0x58E3A588#31.nam=fdv-foff#31.low=0.0#31.hi=1000000.0#31.desc=External Meter#31.unit=dB#31.fps=0#32.src=WVF#32.num=0x58E3A588#32.nam=fdv-clock-offset#32.low=0.0#32.hi=1000000.0#32.desc=External Meter#32.unit=dB#32.fps=0#33.src=WVF#33.num=0x58E3A588#33.nam=fdv-sync-quality#33.low=0.0#33.hi=1.0#33.desc=External Meter#33.unit=dB#33.fps=0#34.src=WVF#34.num=0x58E3A588#34.nam=fdv-total-bits-lsb#34.low=0.0#34.hi=1000000.0#34.desc=External Meter#34.unit=RPM#34.fps=0#35.src=WVF#35.num=0x58E3A588#35.nam=fdv-total-bits-msb#35.low=0.0#35.hi=1000000.0#35.desc=External Meter#35.unit=RPM#35.fps=0#36.src=WVF#36.num=0x58E3A588#36.nam=fdv-error-bits#36.low=0.0#36.hi=1000000.0#36.desc=External Meter#36.unit=RPM#36.fps=0#37.src=WVF#37.num=0x58E3A588#37.nam=fdv-ber#37.low=0.0#37.hi=10000000.0#37.desc=External Meter#37.unit=RPM#37.fps=0#'.encode('utf-8'))
        for i in range(3, 11):
            api_client.lineReceived('R{}|0|'.format(i).encode('utf-8'))

        self.assertEqual(None, self.successResultOf(conn))



if __name__ == '__main__':
    unittest.main()
